version: "2"
name: test /add_authors
vars:
  mysql.url: "filip:password@(localhost:4450)/db"
  api.url: "http://localhost:8081"

testcases:
- name: clean db
  steps:
    - type: sql
      driver: mysql
      dsn: "{{.mysql.url}}"
      commands:
        - "SET FOREIGN_KEY_CHECKS = 0;"
        - "TRUNCATE authors_books;"
        - "TRUNCATE authors;"
        - "SET FOREIGN_KEY_CHECKS = 1;"

- name: create author
  steps:
    - type: http
      method: POST
      url: "{{.api.url}}/authors/new"
      body: >
        {"firstname": "John", "lastname": "Doe"}
      headers: 
        Content-Type: application/json
      assertions:
        - result.statuscode ShouldEqual 201
        - result.bodyjson ShouldContainKey id

- name: create author missing fields
  steps:
    - type: http
      method: POST
      url: "{{.api.url}}/authors/new"
      body: >
        {"firstname": "", "lastname": ""}
      headers: 
        Content-Type: application/json
      assertions:
        - result.statuscode ShouldEqual 400
        - result.bodystring ShouldContain "Firstname and Lastname are required fields"

- name: create author invalid JSON
  steps:
    - type: http
      method: POST
      url: "{{.api.url}}/authors/new"
      body: >
        {invalid-json}
      headers: 
        Content-Type: application/json
      assertions:
        - result.statuscode ShouldEqual 400
        - result.bodystring ShouldContain "Invalid JSON data"

- name: method not allowed
  steps:
    - type: http
      method: GET
      url: "{{.api.url}}/authors/new"
      assertions:
        - result.statuscode ShouldEqual 405
        - result.bodystring ShouldContain "Only POST method is supported"
